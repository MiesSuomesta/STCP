# WIRE FORMAT

## Overview

STCP uses an explicit, length-prefixed framing format to encapsulate all protocol messages transmitted over the underlying TCP connection. The framing format is identical for both handshake and encrypted data frames.

All multi-byte integer fields are encoded using **big-endian** byte order.

## Frame Structure

```
+----------------------+-------------------------------+
| 8 bytes             | Variable length               |
+----------------------+-------------------------------+
| Payload length (BE) | Payload                       |
+----------------------+-------------------------------+
```

The payload content depends on the current protocol state.

## Encrypted Payload Structure (AES mode)

When the connection is in `AES_READY` state, the payload is structured as follows:

```
+----------------------+----------------------+----------------------+
| IV                  | Ciphertext          | Authentication Tag   |
+----------------------+----------------------+----------------------+
```

- **IV**: Initialization Vector used for AES-GCM
- **Ciphertext**: Encrypted application data
- **Authentication Tag**: AES-GCM authentication tag (16 bytes)

## Handshake Payload Structure (Public-key mode)

During the handshake phase, the payload contains protocol messages such as public keys or control messages. These payloads are transmitted without AES encryption but still use the same length-prefixed framing.

## Field Descriptions

- **Payload length**: Total length of the payload in bytes
- **IV**: Initialization vector for AES-GCM encryption
- **Ciphertext**: Encrypted user data
- **Authentication Tag**: Integrity and authenticity tag generated by AES-GCM

## Framing Invariants

- A complete frame must be received before processing
- Partial frames are buffered until complete
- Frames are never interleaved
- Payload length is validated before allocation
